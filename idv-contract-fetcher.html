<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDV Contract Finder | GovCon Giants</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 30px 0;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #aaa;
            max-width: 600px;
            margin: 0 auto;
        }

        .info-banner {
            background: rgba(0, 200, 83, 0.1);
            border: 1px solid rgba(0, 200, 83, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-banner h3 {
            color: #00c853;
            margin-bottom: 10px;
        }

        .info-banner p {
            color: #aaa;
            font-size: 0.95rem;
        }

        .no-key-badge {
            display: inline-block;
            background: linear-gradient(135deg, #00c853, #00d4ff);
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .setup-box {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .setup-box h2 {
            margin-bottom: 20px;
            color: #00d4ff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 1rem;
            outline: none;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #00d4ff;
        }

        .form-group select option {
            background: #1a1a2e;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,212,255,0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            margin-left: 10px;
        }

        .status-box {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .status-box h3 {
            margin-bottom: 10px;
            font-size: 1rem;
            color: #888;
        }

        #status-log {
            font-family: monospace;
            font-size: 0.9rem;
            color: #00d4ff;
            max-height: 150px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .log-error { color: #ff6b6b; }
        .log-success { color: #00c853; }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px 25px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            flex: 1;
            min-width: 140px;
        }

        .stat-number {
            font-size: 1.6rem;
            font-weight: bold;
            color: #00d4ff;
        }

        .stat-label {
            color: #888;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .contract-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .contract-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0,212,255,0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 10px;
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: #fff;
            flex: 1;
            line-height: 1.4;
        }

        .idiq-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            background: linear-gradient(135deg, #7b2cbf, #00d4ff);
            color: #fff;
            white-space: nowrap;
        }

        .prime-contractor {
            background: rgba(0, 200, 83, 0.1);
            border: 1px solid rgba(0, 200, 83, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .prime-contractor h4 {
            color: #00c853;
            font-size: 0.8rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .prime-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 5px;
        }

        .prime-details {
            font-size: 0.85rem;
            color: #aaa;
        }

        .card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .card-section {
            margin-bottom: 10px;
        }

        .card-section-title {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .card-section-content {
            color: #ddd;
            font-size: 0.9rem;
        }

        .value-highlight {
            color: #00d4ff;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .naics-badge {
            display: inline-block;
            padding: 4px 10px;
            background: linear-gradient(135deg, #7b2cbf, #00d4ff);
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8rem;
            color: #fff;
        }

        .agency-tag {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 0.8rem;
            color: #aaa;
            margin-left: 8px;
        }

        .action-box {
            background: rgba(0, 212, 255, 0.1);
            border-left: 3px solid #00d4ff;
            padding: 12px;
            border-radius: 0 8px 8px 0;
            margin-top: 15px;
        }

        .action-box .card-section-title {
            color: #00d4ff;
        }

        .contact-link {
            color: #00d4ff;
            text-decoration: none;
        }

        .contact-link:hover {
            text-decoration: underline;
        }

        .usaspending-link {
            display: inline-block;
            margin-top: 12px;
            padding: 8px 14px;
            background: rgba(0,212,255,0.1);
            border: 1px solid rgba(0,212,255,0.3);
            border-radius: 6px;
            color: #00d4ff;
            text-decoration: none;
            font-size: 0.85rem;
        }

        .usaspending-link:hover {
            background: rgba(0,212,255,0.2);
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #888;
            grid-column: 1 / -1;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 10px 18px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover, .page-btn.active {
            background: #00d4ff;
            color: #000;
            border-color: #00d4ff;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            .card-grid {
                grid-template-columns: 1fr;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="font-size: 1.1rem; font-weight: 600; color: #00d4ff; margin-bottom: 10px; letter-spacing: 1px;">GOVCON GIANTS</div>
            <h1>IDV Contract Finder</h1>
            <p>Find real IDV contracts from USASpending.gov to pursue subcontracting opportunities with prime contractors</p>
        </div>

        <div class="info-banner">
            <h3>Why IDV Contracts Matter</h3>
            <p>IDV (Indefinite Delivery Vehicle) contracts are pre-competed vehicles where prime contractors have already won. Instead of bidding on new opportunities, you can partner with these primes as a subcontractor. This is often the fastest path to federal revenue for small businesses.</p>
        </div>

        <div class="setup-box">
            <h2>Search IDV Contracts</h2>

            <div class="form-row">
                <div class="form-group">
                    <label>NAICS Code (2, 4, or 6 digits)</label>
                    <input type="text" id="naics-code" placeholder="e.g., 54, 5415, or 541512" maxlength="6">
                </div>
                <div class="form-group">
                    <label>Agency</label>
                    <select id="agency">
                        <option value="">All Agencies</option>
                        <option value="Department of Defense">Department of Defense</option>
                        <option value="Department of Health and Human Services">Health and Human Services</option>
                        <option value="Department of Homeland Security">Homeland Security</option>
                        <option value="Department of Veterans Affairs">Veterans Affairs</option>
                        <option value="General Services Administration">GSA</option>
                        <option value="National Aeronautics and Space Administration">NASA</option>
                        <option value="Department of the Interior">Interior</option>
                        <option value="Department of Transportation">Transportation</option>
                        <option value="Department of Energy">Energy</option>
                        <option value="Department of Justice">Justice</option>
                        <option value="Department of the Treasury">Treasury</option>
                        <option value="Department of State">State</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Minimum Value</label>
                    <select id="min-value">
                        <option value="0">Any Value</option>
                        <option value="1000000">$1M+</option>
                        <option value="5000000">$5M+</option>
                        <option value="10000000" selected>$10M+</option>
                        <option value="25000000">$25M+</option>
                        <option value="50000000">$50M+</option>
                        <option value="100000000">$100M+</option>
                        <option value="500000000">$500M+</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="date-from">
                </div>
                <div class="form-group">
                    <label>End Date (blank = unlimited)</label>
                    <input type="date" id="date-to" placeholder="Leave blank for all">
                </div>
                <div class="form-group">
                    <label>State Filter Type</label>
                    <select id="state-filter-type">
                        <option value="recipient">Contractor HQ Location</option>
                        <option value="pop">Work Location (Task Orders)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>State</label>
                    <select id="state-filter">
                        <option value="">All States</option>
                        <option value="AL">Alabama</option>
                        <option value="AK">Alaska</option>
                        <option value="AZ">Arizona</option>
                        <option value="AR">Arkansas</option>
                        <option value="CA">California</option>
                        <option value="CO">Colorado</option>
                        <option value="CT">Connecticut</option>
                        <option value="DE">Delaware</option>
                        <option value="DC">District of Columbia</option>
                        <option value="FL">Florida</option>
                        <option value="GA">Georgia</option>
                        <option value="HI">Hawaii</option>
                        <option value="ID">Idaho</option>
                        <option value="IL">Illinois</option>
                        <option value="IN">Indiana</option>
                        <option value="IA">Iowa</option>
                        <option value="KS">Kansas</option>
                        <option value="KY">Kentucky</option>
                        <option value="LA">Louisiana</option>
                        <option value="ME">Maine</option>
                        <option value="MD">Maryland</option>
                        <option value="MA">Massachusetts</option>
                        <option value="MI">Michigan</option>
                        <option value="MN">Minnesota</option>
                        <option value="MS">Mississippi</option>
                        <option value="MO">Missouri</option>
                        <option value="MT">Montana</option>
                        <option value="NE">Nebraska</option>
                        <option value="NV">Nevada</option>
                        <option value="NH">New Hampshire</option>
                        <option value="NJ">New Jersey</option>
                        <option value="NM">New Mexico</option>
                        <option value="NY">New York</option>
                        <option value="NC">North Carolina</option>
                        <option value="ND">North Dakota</option>
                        <option value="OH">Ohio</option>
                        <option value="OK">Oklahoma</option>
                        <option value="OR">Oregon</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="RI">Rhode Island</option>
                        <option value="SC">South Carolina</option>
                        <option value="SD">South Dakota</option>
                        <option value="TN">Tennessee</option>
                        <option value="TX">Texas</option>
                        <option value="UT">Utah</option>
                        <option value="VT">Vermont</option>
                        <option value="VA">Virginia</option>
                        <option value="WA">Washington</option>
                        <option value="WV">West Virginia</option>
                        <option value="WI">Wisconsin</option>
                        <option value="WY">Wyoming</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Results Per Page</label>
                    <select id="limit">
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" id="fetch-btn" onclick="fetchIDVContracts()">
                    Search IDV Contracts
                </button>
                <button class="btn btn-secondary" id="export-btn" onclick="exportToCSV()" style="display: none;">
                    Export to CSV
                </button>
            </div>

            <div class="status-box">
                <h3>Status</h3>
                <div id="status-log">Ready to search IDV contracts from USASpending.gov...</div>
            </div>
        </div>

        <div class="stats-bar" id="stats-bar" style="display: none;">
            <div class="stat">
                <div class="stat-number" id="total-found">0</div>
                <div class="stat-label">IDV Contracts</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="total-value">$0</div>
                <div class="stat-label">Total Value</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="unique-primes">0</div>
                <div class="stat-label">Prime Contractors</div>
            </div>
        </div>

        <div id="results-grid" class="results-grid"></div>

        <div id="pagination" class="pagination"></div>
    </div>

    <script>
        let fetchedContracts = [];
        let currentPage = 1;
        let hasNextPage = false;

        // Set default start date (4 years ago), leave end date blank for unlimited
        const today = new Date();
        const fourYearsAgo = new Date(today);
        fourYearsAgo.setFullYear(today.getFullYear() - 4);
        document.getElementById('date-from').value = fourYearsAgo.toISOString().split('T')[0];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('status-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry' + (type === 'error' ? ' log-error' : type === 'success' ? ' log-success' : '');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatCurrency(value) {
            if (!value) return 'N/A';
            const num = parseFloat(value);
            if (isNaN(num)) return 'N/A';
            if (num >= 1000000000) return '$' + (num / 1000000000).toFixed(2) + 'B';
            if (num >= 1000000) return '$' + (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return '$' + (num / 1000).toFixed(0) + 'K';
            return '$' + num.toLocaleString();
        }

        async function fetchIDVContracts(page = 1) {
            const naicsCode = document.getElementById('naics-code').value.trim();
            const agency = document.getElementById('agency').value;
            const minValue = parseInt(document.getElementById('min-value').value) || 0;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            const stateFilter = document.getElementById('state-filter').value;
            const stateFilterType = document.getElementById('state-filter-type').value;
            const limit = parseInt(document.getElementById('limit').value);

            const fetchBtn = document.getElementById('fetch-btn');
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'Searching...';

            if (page === 1) {
                document.getElementById('status-log').innerHTML = '';
                log('Connecting to USASpending.gov API for IDV contracts...');
            }

            currentPage = page;

            // Build request body for USASpending.gov API
            const requestBody = {
                filters: {
                    award_type_codes: ["IDV_A", "IDV_B", "IDV_B_A", "IDV_B_B", "IDV_B_C", "IDV_C", "IDV_D", "IDV_E"],
                    award_amounts: [{
                        lower_bound: minValue
                    }]
                },
                fields: [
                    "Award ID",
                    "Recipient Name",
                    "Recipient UEI",
                    "Award Amount",
                    "Total Outlays",
                    "Description",
                    "Start Date",
                    "End Date",
                    "Awarding Agency",
                    "Awarding Sub Agency",
                    "NAICS Code",
                    "NAICS Description",
                    "Contract Award Type",
                    "recipient_id",
                    "Recipient State Code",
                    "Place of Performance City",
                    "Place of Performance State Code",
                    "generated_unique_award_id"
                ],
                page: page,
                limit: limit,
                sort: "Award Amount",
                order: "desc",
                subawards: false
            };

            // Add time period filter only if dates are provided
            if (dateFrom || dateTo) {
                const effectiveStartDate = dateFrom || '2000-01-01';
                const effectiveEndDate = dateTo || new Date().toISOString().split('T')[0];
                requestBody.filters.time_period = [{
                    start_date: effectiveStartDate,
                    end_date: effectiveEndDate
                }];
                log(`Filtering by date range: ${effectiveStartDate} to ${effectiveEndDate}`);
            }

            // Add NAICS filter if provided
            if (naicsCode) {
                // Clean up NAICS - remove trailing zeros
                let cleanNaics = naicsCode.replace(/0+$/, '') || naicsCode;

                // API only accepts NAICS codes of length 2, 4, or 6
                // Adjust to valid length
                if (cleanNaics.length === 1) cleanNaics = cleanNaics + '0';  // 1 -> 2
                else if (cleanNaics.length === 3) cleanNaics = cleanNaics.substring(0, 2);  // 3 -> 2
                else if (cleanNaics.length === 5) cleanNaics = cleanNaics + '0';  // 5 -> 6

                requestBody.filters.naics_codes = { require: [cleanNaics] };
                log(`Filtering by NAICS: ${cleanNaics} (valid lengths: 2, 4, or 6)`);
            }

            // Add agency filter if provided
            if (agency) {
                requestBody.filters.agencies = [{
                    type: "awarding",
                    tier: "toptier",
                    name: agency
                }];
                log(`Filtering by agency: ${agency}`);
            }

            // Add state filter if provided
            if (stateFilter) {
                if (stateFilterType === 'pop') {
                    // For Work Location, search task orders instead of IDVs
                    log(`Searching task orders with work in ${stateFilter}...`);

                    // Change to contract task order types instead of IDV types
                    requestBody.filters.award_type_codes = ["A", "B", "C", "D"];
                    requestBody.filters.place_of_performance_locations = [{
                        country: "USA",
                        state: stateFilter
                    }];
                    log(`Filtering task orders by place of performance: ${stateFilter}`);
                } else {
                    requestBody.filters.recipient_locations = [{
                        country: "USA",
                        state: stateFilter
                    }];
                    log(`Filtering by contractor location: ${stateFilter}`);
                }
            }

            log(`Searching for contracts (Page ${page})...`);
            console.log('Request body:', JSON.stringify(requestBody, null, 2));

            try {
                const response = await fetch('https://api.usaspending.gov/api/v2/search/spending_by_award/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (!response.ok) {
                    const errorMsg = data.detail || data.message || `API returned status ${response.status}`;
                    throw new Error(errorMsg);
                }

                fetchedContracts = data.results || [];
                hasNextPage = data.page_metadata?.hasNext || false;

                log(`Found ${fetchedContracts.length} IDV contracts on page ${page}`, 'success');

                if (fetchedContracts.length > 0) {
                    displayResults(fetchedContracts);
                    document.getElementById('export-btn').style.display = 'inline-block';
                    renderPagination(page, hasNextPage);
                } else {
                    document.getElementById('results-grid').innerHTML = `
                        <div class="no-results">
                            <h3>No IDV contracts found</h3>
                            <p>Try adjusting your filters or expanding the date range</p>
                        </div>
                    `;
                    document.getElementById('stats-bar').style.display = 'none';
                    document.getElementById('pagination').innerHTML = '';
                }

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                log('Check your internet connection and try again', 'error');

                document.getElementById('results-grid').innerHTML = `
                    <div class="no-results">
                        <h3>Unable to fetch IDV contracts</h3>
                        <p style="margin-top: 10px;">Error: ${error.message}</p>
                        <p style="margin-top: 20px;">
                            <a href="https://www.usaspending.gov/search/?tab=contracts" target="_blank" style="color: #00d4ff;">
                                Search directly on USASpending.gov
                            </a>
                        </p>
                    </div>
                `;
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'Search IDV Contracts';
            }
        }

        function displayResults(contracts) {
            const resultsGrid = document.getElementById('results-grid');
            const statsBar = document.getElementById('stats-bar');

            // Calculate stats
            let totalValue = 0;
            const primeSet = new Set();

            contracts.forEach(c => {
                totalValue += parseFloat(c['Award Amount']) || 0;
                if (c['Recipient Name']) primeSet.add(c['Recipient Name']);
            });

            document.getElementById('total-found').textContent = contracts.length;
            document.getElementById('total-value').textContent = formatCurrency(totalValue);
            document.getElementById('unique-primes').textContent = primeSet.size;
            statsBar.style.display = 'flex';

            // Common prime contractor SBLO emails
            const sbloEmails = {
                'BOOZ ALLEN HAMILTON': 'smallbusinesscompliance@bah.com',
                'LEIDOS': 'sbcomp@leidos.com',
                'GENERAL DYNAMICS': 'smallbusiness@gdit.com',
                'CACI': 'smallbusiness@caci.com',
                'SAIC': 'smallbusiness@saic.com',
                'MANTECH': 'smallbusiness@mantech.com',
                'PERATON': 'smallbusiness@peraton.com',
                'NORTHROP GRUMMAN': 'small.business@northropgrumman.com',
                'LOCKHEED MARTIN': 'sefnee.a.manzanares@lmco.com',
                'RAYTHEON': 'small.business@raytheon.com',
                'BAE SYSTEMS': 'Marianne.Tenore@BAESYSTEMS.COM',
                'BOEING': 'small.business@boeing.com',
                'L3HARRIS': 'smallbusiness@l3harris.com',
                'AECOM': 'smallbusiness@aecom.com',
                'JACOBS': 'smallbusiness@jacobs.com',
                'KBR': 'supplierdiversity@kbr.com',
                'FLUOR': 'supplier.diversity@fluor.com',
                'ACCENTURE': 'supplier.diversity@accenturefederal.com',
                'DELOITTE': 'supplierdiversity@deloitte.com',
                'IBM': 'supplierdiversity@ibm.com',
                'MICROSOFT': 'mspartner@microsoft.com',
                'AMAZON': 'aws-publicsector-sblo@amazon.com',
                'ORACLE': 'supplierdiversity@oracle.com'
            };

            function getSbloEmail(recipientName) {
                if (!recipientName) return null;
                const upperName = recipientName.toUpperCase();
                for (const [key, email] of Object.entries(sbloEmails)) {
                    if (upperName.includes(key)) return email;
                }
                return null;
            }

            // Render cards
            resultsGrid.innerHTML = contracts.map(c => {
                const awardId = c['Award ID'] || 'N/A';
                const recipientName = c['Recipient Name'] || 'Unknown Contractor';
                const recipientUei = c['Recipient UEI'] || '';
                const awardAmount = c['Award Amount'];
                const description = c['Description'] || 'IDV Contract';
                const startDate = c['Start Date'];
                const endDate = c['End Date'];
                const agency = c['Awarding Agency'] || '';
                const subAgency = c['Awarding Sub Agency'] || '';
                const naicsCode = c['NAICS Code'] || '';
                const naicsDesc = c['NAICS Description'] || '';
                const stateCode = c['Recipient State Code'] || '';
                const sbloEmail = getSbloEmail(recipientName);
                const generatedId = c['generated_unique_award_id'] || '';

                // USASpending URL - use generated_unique_award_id if available
                let usaSpendingUrl;
                if (generatedId) {
                    usaSpendingUrl = `https://www.usaspending.gov/award/${generatedId}`;
                } else {
                    // Search by Award ID on USASpending
                    usaSpendingUrl = `https://www.usaspending.gov/keyword_search/${encodeURIComponent(awardId)}`;
                }

                return `
                    <div class="contract-card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">${description.substring(0, 150)}${description.length > 150 ? '...' : ''}</h3>
                                <div style="margin-top: 8px;">
                                    ${naicsCode ? `<span class="naics-badge">${naicsCode}</span>` : ''}
                                    ${agency ? `<span class="agency-tag">${subAgency || agency}</span>` : ''}
                                </div>
                            </div>
                            <span class="idiq-badge">IDV</span>
                        </div>

                        <div class="prime-contractor">
                            <h4>Prime Contractor</h4>
                            <div class="prime-name">${recipientName}</div>
                            <div class="prime-details">
                                ${stateCode ? stateCode : ''}
                                ${recipientUei ? ' | UEI: ' + recipientUei : ''}
                            </div>
                        </div>

                        <div class="card-grid">
                            <div class="card-section">
                                <div class="card-section-title">Contract ID</div>
                                <div class="card-section-content" style="font-size: 0.8rem; word-break: break-all;">${awardId}</div>
                            </div>
                            <div class="card-section">
                                <div class="card-section-title">Total Value</div>
                                <div class="card-section-content value-highlight">${formatCurrency(awardAmount)}</div>
                            </div>
                            <div class="card-section">
                                <div class="card-section-title">Start Date</div>
                                <div class="card-section-content">${formatDate(startDate)}</div>
                            </div>
                            <div class="card-section">
                                <div class="card-section-title">End Date</div>
                                <div class="card-section-content">${formatDate(endDate)}</div>
                            </div>
                        </div>

                        ${naicsDesc ? `
                        <div class="card-section">
                            <div class="card-section-title">NAICS Description</div>
                            <div class="card-section-content">${naicsDesc}</div>
                        </div>
                        ` : ''}

                        <div class="action-box">
                            <div class="card-section-title">Subcontracting Contact</div>
                            <div class="card-section-content">
                                ${sbloEmail ?
                                    `SBLO: <a href="mailto:${sbloEmail}" class="contact-link">${sbloEmail}</a>` :
                                    `Search for "${recipientName} small business liaison" or check their website`
                                }
                            </div>
                        </div>

                        <a href="${usaSpendingUrl}" target="_blank" class="usaspending-link">View Full Details on USASpending.gov</a>
                    </div>
                `;
            }).join('');
        }

        function renderPagination(page, hasNext) {
            const pagination = document.getElementById('pagination');

            let html = '';

            if (page > 1) {
                html += `<button class="page-btn" onclick="fetchIDVContracts(${page - 1})">Previous</button>`;
            }

            html += `<button class="page-btn active">Page ${page}</button>`;

            if (hasNext) {
                html += `<button class="page-btn" onclick="fetchIDVContracts(${page + 1})">Next</button>`;
            }

            pagination.innerHTML = html;
        }

        function exportToCSV() {
            if (fetchedContracts.length === 0) {
                log('No contracts to export', 'error');
                return;
            }

            const headers = ['Award ID', 'Recipient Name', 'UEI', 'State', 'NAICS', 'NAICS Description', 'Award Amount', 'Agency', 'Sub Agency', 'Start Date', 'End Date', 'Description', 'USASpending URL'];

            const rows = fetchedContracts.map(c => [
                `"${(c['Award ID'] || '').replace(/"/g, '""')}"`,
                `"${(c['Recipient Name'] || '').replace(/"/g, '""')}"`,
                c['Recipient UEI'] || '',
                c['Recipient State Code'] || '',
                c['NAICS Code'] || '',
                `"${(c['NAICS Description'] || '').replace(/"/g, '""')}"`,
                c['Award Amount'] || '',
                `"${(c['Awarding Agency'] || '').replace(/"/g, '""')}"`,
                `"${(c['Awarding Sub Agency'] || '').replace(/"/g, '""')}"`,
                c['Start Date'] || '',
                c['End Date'] || '',
                `"${(c['Description'] || '').replace(/"/g, '""').substring(0, 200)}"`,
                c['generated_unique_award_id']
                    ? `https://www.usaspending.gov/award/${encodeURIComponent(c['generated_unique_award_id'])}`
                    : ''
            ].join(','));

            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `idv-contracts-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            log(`Exported ${fetchedContracts.length} IDV contracts to CSV`, 'success');
        }
    </script>
</body>
</html>
